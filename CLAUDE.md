# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is the **Diagram Tools Hub** - a unified Docker-based platform that integrates three diagramming tools:
- **Draw.io** - Professional diagrams and flowcharts  
- **Excalidraw** - Hand-drawn style diagrams and wireframes
- **TLDraw** - Modern collaborative drawing canvas

The project uses Docker Compose to orchestrate multiple services behind an Nginx reverse proxy with HTTPS support.

## Common Commands

### Service Management
- `./manage-config.sh start` - Start all services with auto-generated HTTPS
- `./manage-config.sh stop` - Stop all services
- `./manage-config.sh restart` - Restart all services
- `./manage-config.sh rebuild` - Rebuild containers and restart
- `./manage-config.sh status` - Show container status and resource usage
- `./manage-config.sh logs [service]` - View logs for all services or specific service

### Configuration Commands
- `./manage-config.sh show` - Display current configuration
- `./manage-config.sh http-only` - Switch to HTTP-only mode (disable SSL)
- `./manage-config.sh cleanup` - Remove conflicting containers/networks

### System Service
- `sudo ./manage-config.sh install-service` - Install as systemd service for auto-start
- `sudo ./manage-config.sh uninstall-service` - Remove systemd service
- `./manage-config.sh service-status` - Check systemd service status

### TLDraw Development
- `cd tldraw && npm run dev` - Start TLDraw in development mode
- `cd tldraw && npm run build` - Build TLDraw for production
- `docker-compose build --no-cache tldraw` - Rebuild TLDraw container

## Architecture

### Service Structure
- **Engine** (Nginx) - Main reverse proxy and landing page server
  - Handles HTTPS termination and SSL certificate management
  - Routes traffic to backend services via upstream blocks
  - Serves unified dashboard at root path
- **Draw.io** - Runs on port 8081, proxied to `/drawio/`
- **Excalidraw** - Runs on port 8082, proxied to `/excalidraw/`  
- **TLDraw** - Custom built container on port 8083, proxied to `/tldraw/`

### Key Configuration Files
- `docker-compose.yml` - Service orchestration with configurable ports
- `engine/nginx.conf` - Reverse proxy configuration with HTTPS support
- `tldraw/vite.config.js` - Vite dev server config with `allowedHosts: true`
- `.env` - Environment variables for ports and SSL configuration
- `manage-config.sh` - Main management script with comprehensive operations

### SSL/HTTPS Configuration
- Auto-generates self-signed certificates if none exist
- Supports custom certificates via command line arguments
- HTTP traffic automatically redirects to HTTPS
- Configurable ports via environment variables

### Environment Variables
Key variables in `.env`:
```bash
HTTP_PORT=8080              # HTTP port (when HTTPS disabled)
HTTPS_PORT=443              # HTTPS port  
HTTP_REDIRECT_PORT=80       # HTTP redirect port
SSL_DOMAIN=localhost        # SSL certificate domain
TLDRAW_DEBUG_PANEL=false    # TLDraw debug settings
```

## Development Notes

### TLDraw Specifics
- Uses Vite as build system with React
- Built from source using custom Dockerfile
- Configured with `base: '/tldraw/'` for reverse proxy support
- `allowedHosts: true` prevents "Blocked request" errors in dev mode

### Docker Network
- All services use shared network: `diagram-tools-network`
- Internal communication uses container names as hostnames
- External access through Nginx reverse proxy only

### SSL Certificate Management
- Certificates stored in `./certs/` directory
- Auto-generated with 365-day validity and SAN entries
- Can be regenerated by removing `./certs/` and restarting services

## Access Points

- **Main Hub**: https://localhost (or configured HTTPS_PORT)
- **Draw.io**: https://localhost/drawio/
- **Excalidraw**: https://localhost/excalidraw/  
- **TLDraw**: https://localhost/tldraw/
- **Health Check**: https://localhost/health

## Troubleshooting

### Port Conflicts
Check what's using ports: `lsof -i :80-8083`
Update `.env` with custom ports and restart services

### Container Issues
- `./manage-config.sh cleanup` - Remove conflicting resources
- `./manage-config.sh clean-rebuild` - Complete rebuild from scratch
- `docker-compose logs -f [service]` - Debug specific service

### SSL Issues  
- Browser security warnings are normal for self-signed certificates
- Remove `./certs/` directory to regenerate certificates
- Use `./manage-config.sh http-only` to disable SSL entirely